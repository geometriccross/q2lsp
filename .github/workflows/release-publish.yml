name: release-publish

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

concurrency:
  group: release-publish-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    outputs:
      version: ${{ steps.release-meta.outputs.version }}
      prerelease: ${{ steps.release-meta.outputs.prerelease }}
      stable: ${{ steps.release-meta.outputs.stable }}
      artifact-name: ${{ steps.artifact-meta.outputs.name }}
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          persist-credentials: false

      - name: Setup Pixi
        uses: prefix-dev/setup-pixi@a0af7a228712d6121d37aba47adf55c1332c9c2e
        with:
          cache: true

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405
        with:
          python-version: "3.10"

      - name: Verify release tag matches project version
        id: release-meta
        shell: bash
        run: |
          set -euo pipefail

          tag="${GITHUB_REF_NAME}"
          tag_version="${tag#v}"

          project_version="$(python - <<'PY'
          import re
          from pathlib import Path

          text = Path("pyproject.toml").read_text(encoding="utf-8")
          project_section = re.search(r"(?ms)^\[project\]\s*(.*?)(?=^\[|\Z)", text)
          if project_section is None:
              raise SystemExit("[project] section not found in pyproject.toml")

          version_match = re.search(
              r"(?m)^\s*version\s*=\s*[\"']([^\"']+)[\"']\s*$", project_section.group(1)
          )
          if version_match is None:
              raise SystemExit("project.version not found in pyproject.toml")

          print(version_match.group(1))
          PY
          )"

          if [[ "${tag_version}" != "${project_version}" ]]; then
            echo "Release tag (${tag_version}) does not match pyproject.toml version (${project_version})." >&2
            exit 1
          fi

          if [[ "${tag_version}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            prerelease="false"
            stable="true"
          elif [[ "${tag_version}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(a|b|rc)[0-9]+$ ]]; then
            prerelease="true"
            stable="false"
          else
            echo "Tag version '${tag_version}' is not a supported stable/prerelease format." >&2
            exit 1
          fi

          echo "version=${tag_version}" >> "${GITHUB_OUTPUT}"
          echo "prerelease=${prerelease}" >> "${GITHUB_OUTPUT}"
          echo "stable=${stable}" >> "${GITHUB_OUTPUT}"

      - name: Run ruff check
        run: pixi run -e dev ruff check .

      - name: Run ruff format check
        run: pixi run -e dev ruff format --check .

      - name: Run pyright
        run: pixi run -e dev pyright

      - name: Run pytest
        run: pixi run -e dev pytest

      - name: Install build tools
        run: python -m pip install --upgrade build twine

      - name: Build distributions
        run: python -m build

      - name: Validate built distributions
        run: twine check dist/*

      - name: Set artifact metadata
        id: artifact-meta
        run: echo "name=python-package-distributions" >> "${GITHUB_OUTPUT}"

      - name: Upload distributions
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: ${{ steps.artifact-meta.outputs.name }}
          path: dist/

  publish-testpypi:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: build
    permissions:
      contents: read
      id-token: write
    environment:
      name: testpypi
    steps:
      - name: Download distributions
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: dist/

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e
        with:
          repository-url: https://test.pypi.org/legacy/

  publish-pypi:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs:
      - build
      - publish-testpypi
    if: ${{ needs.build.outputs.stable == 'true' }}
    permissions:
      contents: read
      id-token: write
    environment:
      name: pypi
    steps:
      - name: Download distributions
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e
